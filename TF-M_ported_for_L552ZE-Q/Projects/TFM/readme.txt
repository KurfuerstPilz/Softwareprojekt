/**
  @page TFM

  @verbatim
  ******************** (C) COPYRIGHT 2019 STMicroelectronics *******************
  * @file    readme.txt
  * @brief   This application shows Trusted Firmware on Cortex-M (TFM)
  ******************************************************************************
  *
  * Copyright (c) 2019 STMicroelectronics. All rights reserved.
  *
  * This software component is licensed by ST under Ultimate Liberty license
  * SLA0044, the "License"; You may not use this file except in compliance with
  * the License. You may obtain a copy of the License at:
  *                               www.st.com/SLA0044
  *
  ******************************************************************************
  @endverbatim
par Application Licence Clarification

The application TFM components are licenced by ST under Ultimate Liberty 
license SLA0044. Read the file q_a.txt for Application Licence Clarification.

@par Application Description 

The TFM provides a Root of Trust solution including Secure Boot and Secure
Firmware Update functionalities that is used before executing the application
and provides a set of secure services that are isolated form the non-secure
application but can be used by the non-secure application at run-time.

TFM application is based on the Open Source TF-M reference implementation
that has been ported on STM32 microcontroller to take benefit of STM32 HW
security features such as CM33 Trust Zone/MPU, Trust Zone aware peripherals,
Memory protections (HDP, WRP) and enhanced life cycle scheme.

The Secure Boot and Secure Firmware Update solution allows the update of the
STM32 microcontroller built-in program with new firmware versions, adding new
features and correcting potential issues. The update process is performed in
a secure way to prevent unauthorized updates and access to confidential
on-device data:

-	The Secure Boot (Root of Trust services) is an immutable code, always
    executed after a system reset, that checks STM32 static protections,
    activates STM32 runtime protections and then verifies the authenticity
    (RSA 3072 signature) and integrity (SHA256) of the application code
    before every execution in order to ensure that invalid or malicious
    code cannot be run. The default RSA key is taken from 
    Middlewares/Third_Party/trustedfirmware/bl2/ext/mcuboot/keys.c 
    and is embedded in the provisionned data area in the secure boot and secure
    firmware update binary.

-	The Secure Firmware Update application is an immutable code that detects
    that a new firmware image is available, that checks its authenticity, and
    that checks the integrity of the code before installing it. The firmware
    update can be done either on the secure part of firmware image or/and on
    the non-secure part of the firmware image.

The secure services are an updatable code implementing a set of services
managing critical assets that are isolated from the non-secure application
so that the non-secure application can’t access directly to any of the critical
assets but can only use secure services that use the critical assets:

-	Crypto: secure cryptographic services based on opaque key APIs

-	Secure Storage: protect data Confidentiality/authenticity/Integrity

-	Internal Trusted Storage

-	Attestation: prove product identity via Entity Attestation Token

For more details, refer to UM2671 "Getting Started with the TF-M applications"
available from the STMicroelectronics microcontroller website www.st.com.

@par Directory contents

   - Linker     Linker files definition shared between TFM_SBSFU_Boot and TFM_Appli
   - TFM_Appli  Secure services application and example of non-secure user
                application. Refer to TFM_Appli\readme.txt.
   - TFM_SBSFU_Boot
				Secure boot and secure firmware update application
                Refer to TFM_SBSFU_Boot\readme.txt.

@par Hardware and Software environment

  - This example runs on STM32L562xx devices.
  
  - This example has been tested with an STMicroelectronics STM32L562E-DK
    board and can be easily tailored to any other supported device 
    and development board.

  - This example needs a terminal emulator supporting YModem protocol.
    (Tera Term for example, open source free software terminal emulator
    that can be downloaded from https://osdn.net/projects/ttssh2/)

  - This example needs at least STM32CubeProgrammer v2.2.0 version,
    available on www.st.com.

@Known limitations

  - IAR build not working if cube package is installed on a path with a space

@par How to use it ? 

Several steps to run TFM application :

1. Build

   Build the TFM projects in the following order. This is mandatory as each
   projects requests some objects generated by the compilation of the previous
   one:
   1- Build TFM_SBSFU_Boot project.
      This step creates the secure boot and secure firmware update binary
      including provisionned user data (keys, IDs...).
      Depending on toolchain, it is located here:
        STM32CubeIDE: TFM_SBSFU_Boot\STM32CubeIDE\Release\TFM_SBSFU_Boot.bin
        EWARM:        TFM_SBSFU_Boot\EWARM\STM32L562E-DK_TFM_SBSFU_Boot\Exe\Project.bin
        MDK-ARM:      TFM_SBSFU_Boot\MDK-ARM\STM32L562E-DK\Exe\Project.bin

   2- Build TFM_Appli Secure project.
      This step creates the TFM Secure binary:
        STM32CubeIDE: TFM_Appli\STM32CubeIDE\Secure\Release\TFM_Appli_Secure.bin
        EWARM:        TFM_Appli\EWARM\STM32L562E-DK_S\Exe\Project.bin
        MDK-ARM:      TFM_Appli\MDK-ARM\STM32L562E-DK_S\Exe\Project.bin
      It also produces the TFM Secure signed binary in TFM_Appli\Binary\tfm_s_sign.bin.

   3- Build TFM_Appli Non Secure project.
      This step creates the TFM Non Secure binary:
        STM32CubeIDE: TFM_Appli\STM32CubeIDE\NonSecure\Release\TFM_Appli_NonSecure.bin
        EWARM:        TFM_Appli\EWARM\STM32L562E-DK_NS\Exe\Project.bin
        MDK-ARM:      TFM_Appli\MDK-ARM\STM32L562E-DK_NS\Exe\Project.bin
      It also produced the TFM Non Secure signed binary in TFM_Appli\Binary\tfm_ns_sign.bin.

2. Initialize the device

   Depending on your toolchain, execute regression script (relying on
   STM32CubeProgrammer CLI tool) to easily perform device initialization in a
   shot:
     STM32CubeIDE: TFM_SBSFU_Boot\STM32CubeIDE\regression.bat or regression.sh
     EWARM:        TFM_SBSFU_Boot\EWARM\regression.bat
     MDK-ARM:      TFM_SBSFU_Boot\MDK-ARM\regression.bat

   As an alternative, it is also possible to initialize and verify manually the
   Option Bytes by means of STM32CubeProgrammer GUI tool:
   - Please ensure with STM32CubeProgammer the following Option bytes
     configuration for the device:
     - RDP         = 0xAA (RDP Level 0)
     - DBANK       = 1 (Dual bank mode enabled)
     - TZEN        = 1 (TrustZone security enabled)
     - SECBOOTADD0 = 0x180010 (boot entry point address 0x0C000800)
     - SRAM2-RST   = 0 (SRAM2 erased at each reset)
   - Ensure also that these protections are all disabled in the Option Bytes
     configuration: BootLock, HDP, WRP, SECWM.
   - Ensure also that device is mass erased.

3. Use a terminal emulator

   Serial port configuration should be :
   - Baud rate    = 115200
   - Data         = 8 bits
   - Parity       = none
   - Stop         = 1 bit
   - Flow control = none 
   Terminal emulator is used for UART connection with the board.
   Connect terminal emulator to COM port of the board.
   The terminal emulator is used to log TFM informations, and enter commands
   for User application.

4. Program the TFM into internal flash

   Depending on your toolchain, execute script TFM_UPDATE (relying on
   STM32CubeProgrammer CLI tool) to easily program the TFM into device internal
   flash in one shot:
     STM32CubeIDE: TFM_SBSFU_Boot\STM32CubeIDE\TFM_UPDATE.bat or TFM_UPDATE.sh
     EWARM:        TFM_SBSFU_Boot\EWARM\TFM_UPDATE.bat
     MDK-ARM:      TFM_SBSFU_Boot\MDK-ARM\TFM_UPDATE.bat

5. Reset the board

   Press the board reset button, and check the log information on the terminal
   emulator:
     - TFM_SBSFU_Boot application starts
     - Then it configures the static protections (because 'development mode'
       is used by default)
     - Then it get locked (because intrusion is detected)

6. Unlock the board

   To exit from locked state (intrusion), remove the jumper JP2 on the board,
   then put it back in place. Check the log information:
     - TFM_SBSFU_Boot starts
     - Then it checks the static protections
     - Then it initializes the BL2 NV area (BootLoader2 Non Volatile area)
     - Then it jumps to the TFM_Appli application, displaying the User Application
       Main menu.

7. Use User App

   This user application gives access to a Main menu which allows to:
   1 - Download a new firmware image
   2 - Test protections
   3 - Test TFM Secure services

   1. Press 1 to enter New Fw Download menu

      It is possible to download a new TFM Secure image or TFM Non Secure image or both.
      - Download Secure Image (#1): Download Secure signed image (ex: TFM_Appli\binary\tfm_s_sign.bin)
      - Download NonSecure Image (#2): Download Non Secure signed image (ex: TFM_Appli\binary\tfm_ns_sign.bin)

      In both cases, send the signed binary with Tera Term by using menu:
      "File > Transfer > YMODEM > Send..."

      After the download(s), press (#3) to reset the board, or press the board
      reset button.
      After reset, the downloaded firmware image(s) is(are) detected, verified,
      installed and executed, by TFM_SBSFU_Boot.

   2. Press 2 to enter test protections menu

      - NonSecure try to access to Secure (#1): test unauthorized access to
        Secure side from Non Secure side. A fault occurs, then reset is performed.
        Several succesives unauthorized accesses to different areas are performed.

      - RDP regression (#2): For 'production mode', put the device in a state
        where RDP regresion can be performed. The RDP regression can be performed
        either by connecting STM32CubeProgrammer tool in HotPlug mode and
        performing RDP level regression to RDP level 0, or by executing the
        regression script (described in step 2).

      Return to previous menu by pressing x.

   3. Press 3 to enter test TFM menu

      This menu allows to test TFM Secure services from Non Secure side through
      PSA API usage.
      - All tests (#0):            Execute all below tests in a row
      - AES-GCM (#1):              Test AES-GCM crypto service
      - AES-CBC (#2):              Test AES-CBC crypto service
      - SST set UID (#3):          Test UID creation in Secure Storage area
      - SST read / check UID (#4): Test UID read / check in Secure Storage area
      - SST remove UID (#5):       Test UID removal in Secure Storage area
      - EAT (#6):                  Test Initial Attestation
      - ITS set UID (#7):          Test UID creation in Internal Trusted Storage area
      - ITS read / check UID (#8): Test UID read / check in Internal Trusted Storage area
      - ITS remove UID (#9):       Test UID removal in Internal Trusted Storage area
      - SHA224 (#a):               Test SHA224 crypto service
      - SHA256 (#b):               Test SHA256 crypto service

      Return to previous menu by pressing x.

 * <h3><center>&copy; COPYRIGHT STMicroelectronics</center></h3>
 */
